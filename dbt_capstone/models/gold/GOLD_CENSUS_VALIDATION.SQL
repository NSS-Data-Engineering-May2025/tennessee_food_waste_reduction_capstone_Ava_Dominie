{{ config(materialized='table') }}

WITH nass AS (
    SELECT
        YEAR,
        COUNTY_NAME,
        COUNTY_CODE,
        COMMODITY_DESC,
        CASE 
            WHEN REGEXP_REPLACE(TRIM(PRODUCTION), '[^0-9.]', '') <> '' 
            THEN TRY_CAST(REGEXP_REPLACE(TRIM(PRODUCTION), '[^0-9.]', '') AS NUMBER)
            ELSE NULL
        END AS PRODUCTION
    FROM {{ source('SILVER','SILVER_PRODUCTION') }}
    WHERE YEAR = 2024
),

census AS (
    SELECT
        YEAR AS CENSUS_YEAR,
        COUNTY,
        COUNTY_ANSI AS COUNTY_CODE,
        COMMODITY,
        CASE 
            WHEN REGEXP_REPLACE(TRIM(VALUE), '[^0-9.]', '') <> '' 
            THEN TRY_CAST(REGEXP_REPLACE(TRIM(VALUE), '[^0-9.]', '') AS NUMBER)
            ELSE NULL
        END AS CENSUS_PRODUCTION
    FROM {{ source('SILVER','SILVER_TENNESSEE_COUNTY_CROP_PRODUCTION_2022') }}
)

SELECT
    n.COUNTY_NAME,
    n.COUNTY_CODE,
    n.COMMODITY_DESC,
    c.CENSUS_YEAR,
    n.YEAR AS NASS_YEAR,
    c.CENSUS_PRODUCTION,
    n.PRODUCTION AS NASS_PRODUCTION,
    (n.PRODUCTION - c.CENSUS_PRODUCTION) AS DIFFERENCE,
    CASE 
        WHEN c.CENSUS_PRODUCTION > 0 
        THEN ROUND((n.PRODUCTION - c.CENSUS_PRODUCTION) / c.CENSUS_PRODUCTION * 100, 2) 
    END AS PERCENT_DIFFERENCE
FROM census c
LEFT JOIN nass n
  ON n.COUNTY_CODE = c.COUNTY_CODE
 AND n.COMMODITY_DESC = c.COMMODITY
